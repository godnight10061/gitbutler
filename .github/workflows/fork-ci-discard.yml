name: Fork CI (discard fix)

on:
  workflow_dispatch:
    inputs:
      sha:
        type: string
        required: true
        description: Target SHA to test (e.g. the head commit of your PR branch)
      run_e2e:
        type: boolean
        required: false
        default: true
        description: Run Playwright E2E (can be slow)

env:
  RUST_BACKTRACE: full
  RUSTUP_TOOLCHAIN: stable

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      DESKTOP_PORT: 3000
      BUTLER_PORT: 6978
      VITE_E2E: 'true'
      VITE_BUTLER_PORT: 6978
      VITE_BUTLER_HOST: 'localhost'
      VITE_BUILD_TARGET: 'web'
    steps:
      - name: Checkout (target SHA)
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          ref: ${{ inputs.sha }}

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Dependencies for 'keyring'
        run: sudo ./scripts/install-minimal-debian-dependencies.sh

      - name: Preset Git configuration and but-testing location
        run: |
          echo "GIT_CONFIG_GLOBAL=$PWD/e2e/playwright/fixtures/.gitconfig" >> $GITHUB_ENV
          echo BUT_TESTING=$PWD/target/debug/but-testing >> $GITHUB_ENV

      - name: Setup node environment
        uses: ./.github/actions/init-env-node

      - name: Node checks
        run: |
          pnpm prettier .
          pnpm lint
          pnpm check
          pnpm test

      - name: Build gitbutler-git
        run: cargo build -p gitbutler-git

      - name: Build but-server
        run: cargo build -p but-server

      - name: Build but-testing
        run: cargo build -p but-testing

      - name: Build SvelteKit
        run: pnpm build:desktop

      - name: Install Playwright browsers
        if: ${{ inputs.run_e2e }}
        run: cd e2e && pnpm exec playwright install --with-deps

      - name: Run Playwright E2E
        if: ${{ inputs.run_e2e }}
        run: pnpm exec turbo run test:e2e:playwright

      - uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: |
            ./e2e/playwright-report/
            ./e2e/test-results/
          retention-days: 30
